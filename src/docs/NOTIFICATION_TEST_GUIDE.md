# 실시간 알림 시스템 테스트 가이드 🧪

## 테스트 준비

### 1. Supabase Realtime 활성화

Supabase Dashboard에서 SQL Editor를 열고 다음 파일을 실행하세요:

```sql
-- /database/enable_realtime_notifications.sql 내용
ALTER PUBLICATION supabase_realtime ADD TABLE auth_users;
ALTER PUBLICATION supabase_realtime ADD TABLE account_verifications;
ALTER PUBLICATION supabase_realtime ADD TABLE transfer_requests;
ALTER PUBLICATION supabase_realtime ADD TABLE wallets;
ALTER PUBLICATION supabase_realtime ADD TABLE deposits;
ALTER PUBLICATION supabase_realtime ADD TABLE withdrawals;
```

### 2. 브라우저 준비

**권장 방식**: 시크릿 모드 + 일반 모드를 동시에 사용
- **일반 모드**: 관리자 계정 로그인
- **시크릿 모드**: 사용자 계정 로그인

또는

**2개의 다른 브라우저 사용**:
- **Chrome**: 관리자 계정
- **Firefox**: 사용자 계정

---

## 📝 테스트 시나리오

### 시나리오 1: 회원가입 → 관리자 알림

**목적**: 새 사용자가 가입하면 관리자에게 즉시 알림이 가는지 확인

**단계**:
1. **관리자 브라우저**: 관리자 계정으로 로그인, 대시보드 열기
2. **사용자 브라우저**: 회원가입 페이지로 이동
3. **사용자**: 새 계정으로 회원가입 진행
4. **관리자**: 우측 상단 🔔 아이콘에 빨간 배지 (1) 표시 확인
5. **관리자**: 🔔 클릭하여 알림 확인: "새 회원 가입: {username}님이 가입했습니다"

**예상 결과**:
- ✅ 관리자 화면 우측 하단에 토스트 알림 표시
- ✅ 🔔 아이콘에 빨간 배지 표시
- ✅ 알림 센터에 "새 회원 가입" 알림 표시 (초록색 아이콘)

---

### 시나리오 2: 1원 인증 요청 → 관리자 알림

**목적**: 사용자가 1원 인증을 요청하면 관리자에게 즉시 알림이 가는지 확인

**단계**:
1. **관리자 브라우저**: 관리자 대시보드 열기
2. **사용자 브라우저**: 사용자 계정으로 로그인
3. **사용자**: "계좌 인증" 메뉴로 이동
4. **사용자**: 은행, 계좌번호, 예금주명 입력 후 "인증 요청" 클릭
5. **관리자**: 🔔 아이콘 배지 업데이트 확인
6. **관리자**: 알림 센터에서 "1원 인증 요청" 알림 확인

**예상 결과**:
- ✅ 관리자에게 토스트 알림: "1원 인증 요청"
- ✅ 알림 센터에 파란색 아이콘으로 표시
- ✅ 읽지 않은 알림은 파란색 배경

---

### 시나리오 3: 1원 인증 승인 → 사용자 알림

**목적**: 관리자가 1원 인증을 승인하면 사용자에게 즉시 알림이 가는지 확인

**단계**:
1. **사용자 브라우저**: 사용자 계정으로 로그인, 홈 화면 유지
2. **관리자 브라우저**: "계좌 인증 관리" 메뉴로 이동
3. **관리자**: 대기 중인 인증 요청 찾기
4. **관리자**: 입금 금액(예: 217원) 입력 후 "승인" 클릭
5. **사용자**: 🔔 아이콘 배지 업데이트 확인
6. **사용자**: 알림 센터에서 "계좌 인증 완료" 알림 확인

**예상 결과**:
- ✅ 사용자에게 토스트 알림: "계좌 인증 완료"
- ✅ 메시지: "1원 인증이 승인되었습니다. 이제 모든 기능을 사용할 수 있습니다"
- ✅ 초록색 배경의 성공 알림

---

### 시나리오 4: 코인 구매 요청 → 관리자 알림

**목적**: 사용자가 코인 구매를 요청하면 관리자에게 즉시 알림이 가는지 확인

**단계**:
1. **관리자 브라우저**: 관리자 대시보드 열기
2. **사용자 브라우저**: "코인 구매" 메뉴로 이동
3. **사용자**: 코인 종류(KRWQ) 선택, 금액(10000원) 입력
4. **사용자**: "구매 요청" 클릭
5. **관리자**: 🔔 아이콘 배지 업데이트 확인
6. **관리자**: 알림 센터에서 "새 구매 요청: KRWQ 10,000원" 확인

**예상 결과**:
- ✅ 관리자에게 토스트 알림
- ✅ 보라색 쇼핑카트 아이콘
- ✅ "새 구매 요청: KRWQ 10,000원 구매 요청" 메시지

---

### 시나리오 5: 구매 승인 → 사용자 알림

**목적**: 관리자가 구매를 승인하면 사용자에게 즉시 알림이 가는지 확인

**단계**:
1. **사용자 브라우저**: 홈 화면 유지
2. **관리자 브라우저**: "구매 요청 관리" 메뉴로 이동
3. **관리자**: 대기 중인 구매 요청 찾기
4. **관리자**: "승인" 버튼 클릭
5. **사용자**: 토스트 알림 및 🔔 배지 확인
6. **사용자**: 알림 센터에서 "구매 승인" 알림 확인

**예상 결과**:
- ✅ 사용자에게 토스트 알림: "구매 승인"
- ✅ "KRWQ 10,000원 구매가 승인되었습니다"
- ✅ 초록색 배경

---

### 시나리오 6: 구매 완료 → 사용자 알림

**목적**: 구매가 완료되면 사용자에게 즉시 알림이 가는지 확인

**단계**:
1. **사용자 브라우저**: 홈 화면 유지
2. **관리자 브라우저**: "구매 요청 관리"에서 승인된 요청 찾기
3. **관리자**: "완료" 버튼 클릭 (또는 자동 완료 대기)
4. **사용자**: 토스트 알림 및 🔔 배지 확인
5. **사용자**: 알림 센터에서 "구매 완료 🎉" 알림 확인

**예상 결과**:
- ✅ 사용자에게 토스트 알림: "구매 완료"
- ✅ "KRWQ 10,000원 구매가 완료되었습니다"
- ✅ 초록색 배경

---

### 시나리오 7: 구매 거절 → 사용자 알림

**목적**: 관리자가 구매를 거절하면 사용자에게 즉시 알림이 가는지 확인

**단계**:
1. **사용자 브라우저**: 새 구매 요청 생성
2. **관리자 브라우저**: "구매 요청 관리"로 이동
3. **관리자**: "거절" 버튼 클릭, 사유 입력 (예: "입금 확인 불가")
4. **사용자**: 토스트 알림 확인
5. **사용자**: 알림 센터에서 "구매 거절" 알림 확인

**예상 결과**:
- ✅ 사용자에게 토스트 알림: "구매 거절"
- ✅ "구매 요청이 거절되었습니다. 사유: 입금 확인 불가"
- ✅ 빨간색 배경

---

## 🎯 체크리스트

### 관리자 알림
- [ ] 회원가입 알림 수신
- [ ] 1원 인증 요청 알림 수신
- [ ] 구매 요청 알림 수신
- [ ] 배지에 읽지 않은 개수 표시
- [ ] 토스트 알림 표시
- [ ] 알림 클릭 시 읽음 처리
- [ ] 알림 삭제 기능
- [ ] "모두 읽음으로 표시" 기능
- [ ] "모든 알림 지우기" 기능

### 사용자 알림
- [ ] 1원 인증 승인 알림 수신
- [ ] 1원 인증 거절 알림 수신
- [ ] 구매 승인 알림 수신
- [ ] 구매 완료 알림 수신
- [ ] 구매 거절 알림 수신
- [ ] 배지에 읽지 않은 개수 표시
- [ ] 토스트 알림 표시
- [ ] 알림 클릭 시 읽음 처리

### UI/UX
- [ ] 알림 아이콘 애니메이션 (펄스 효과)
- [ ] 타입별 색상 구분 (초록/빨강/노랑)
- [ ] 읽지 않은 알림 배경색 구분
- [ ] 커스텀 스크롤바 표시
- [ ] 외부 클릭 시 드롭다운 닫기
- [ ] 반응형 디자인 (모바일/데스크톱)

---

## 🐛 디버깅 팁

### Console에서 확인할 것들

#### 1. Supabase Realtime 연결 확인
```javascript
// 브라우저 Console에서
console.log('Supabase connected:', supabase)
```

#### 2. 로컬 스토리지 알림 확인
```javascript
// 브라우저 Console에서
const userId = 'your-user-id';
const notifications = JSON.parse(localStorage.getItem(`notifications_${userId}`));
console.log('Stored notifications:', notifications);
```

#### 3. 채널 구독 상태 확인
```javascript
// useNotifications 훅에서 자동으로 로깅됨
// Console에서 다음 메시지 확인:
// - "Supabase channel subscribed"
// - "postgres_changes received"
```

### 문제 해결

#### 알림이 오지 않을 때
1. **Supabase Realtime 확인**:
   - Supabase Dashboard > Database > Replication 확인
   - Publication에 테이블이 추가되었는지 확인

2. **RLS 정책 확인**:
   - 각 테이블의 RLS 정책이 올바른지 확인
   - 사용자가 자신의 데이터만 볼 수 있는지 확인

3. **브라우저 Console 확인**:
   - 에러 메시지가 있는지 확인
   - Network 탭에서 Websocket 연결 확인

#### 알림이 중복으로 올 때
- 정상 동작입니다 (여러 탭을 열었을 경우)
- 각 탭이 독립적으로 구독하기 때문

#### 알림이 즉시 사라질 때
- 토스트 알림은 5초 후 자동 사라짐
- 알림 센터에는 계속 보관됨

---

## 📊 성능 모니터링

### 알림 수신 시간 측정

```javascript
// 테스트 시 Console에 시간 로깅
console.time('notification-received');
// 알림 발생 시점
// ...
console.timeEnd('notification-received');
// 예상: 1초 이내
```

### 메모리 사용량 확인

```javascript
// 브라우저 DevTools > Performance > Memory
// 알림 100개 저장 시 메모리 사용량 확인
```

---

## ✅ 테스트 완료 기준

모든 시나리오가 성공하고, 다음 조건을 만족하면 테스트 완료:

1. ✅ 관리자가 모든 사용자 액션을 실시간으로 알림받음
2. ✅ 사용자가 모든 관리자 액션을 실시간으로 알림받음
3. ✅ 알림이 1초 이내에 도착
4. ✅ 토스트와 배지가 정확히 표시됨
5. ✅ 읽음/읽지 않음 상태가 올바르게 관리됨
6. ✅ 알림 삭제 및 전체 삭제 기능이 작동함
7. ✅ 페이지 새로고침 후에도 알림이 유지됨
8. ✅ UI가 깔끔하고 반응형임

---

## 🎉 축하합니다!

모든 테스트를 통과했다면, 실시간 알림 시스템이 완벽하게 구현된 것입니다! 🚀

이제 관리자와 사용자 모두 최고의 경험을 누릴 수 있습니다. 💯
